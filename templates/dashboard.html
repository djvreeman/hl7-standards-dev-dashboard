<!DOCTYPE html>
<html lang="en" class="wa-theme-default wa-palette-default wa-brand-red wa-neutral-gray wa-success-green wa-warning-yellow wa-danger-orange">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HL7 KPI Dashboard</title>
    
    <!-- WebAwesome CSS -->
    <link rel="stylesheet" href="https://cdn.webawesome.com/css/webawesome.min.css">
    
    <!-- HL7 Brand Fonts -->
    <link rel="stylesheet" href="/static/css/fonts.css">
    
    <!-- Custom styles -->
    <style>
        :root {
            --primary-color: #ec2227; /* HL7 RED */
            --secondary-color: #747679; /* HL7 DARK GRAY */
            --success-color: #0f8e48; /* HL7 GREEN */
            --warning-color: #ffcc32; /* HL7 YELLOW */
            --danger-color: #ea7125; /* HL7 ORANGE */
            --info-color: #5f9baf; /* HL7 LIGHT BLUE */
            --dark-color: #010101; /* HL7 BLACK */
            --light-gray: #babcbe; /* HL7 LIGHT GRAY */
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --border-color: #e2e8f0;
        }
        
        /* WebAwesome Theme Classes - Updated to HL7 Brand Colors */
        .wa-theme-default {
            --wa-brand: #ec2227;
            --wa-neutral: #747679;
            --wa-success: #0f8e48;
            --wa-warning: #ffcc32;
            --wa-danger: #ea7125;
        }
        
        .wa-palette-default {
            --wa-palette-primary: #ec2227;
            --wa-palette-secondary: #747679;
            --wa-palette-success: #0f8e48;
            --wa-palette-warning: #ffcc32;
            --wa-palette-danger: #ea7125;
        }
        
        .wa-brand-red {
            --wa-brand: #ec2227;
            --wa-primary: #ec2227;
        }
        
        .wa-neutral-gray {
            --wa-neutral: #747679;
            --wa-secondary: #747679;
        }
        
        .wa-success-green {
            --wa-success: #0f8e48;
        }
        
        .wa-warning-yellow {
            --wa-warning: #ffcc32;
        }
        
        .wa-danger-orange {
            --wa-danger: #ea7125;
        }
        
        body {
            background-color: var(--background-color);
            font-family: var(--font-family-primary);
            margin: 0;
            padding: 0;
        }
        
        .dashboard-header {
            background: white;
            color: #1f2937;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            padding: 2rem 2rem 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
        }
        
        .logo-image {
            height: 80px;
            width: auto;
        }
        
        .header-title {
            flex: 1;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }
        
        .dashboard-subtitle {
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-top: 0.5rem;
        }
        
        .navigation-container {
            background: linear-gradient(135deg, var(--primary-color), #b91c1c);
            padding: 1rem 2rem;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .dashboard-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .navigation {
            display: flex;
            gap: 1rem;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Dropdown Navigation Styles */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .nav-dropdown .nav-link {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            text-decoration: none;
            color: white;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            z-index: 1000;
            border: 1px solid var(--border-color);
            margin-top: 2px;
        }
        
        .dropdown-item {
            display: block;
            padding: 0.75rem 1rem;
            color: #374151;
            text-decoration: none;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: #f9fafb;
            color: var(--primary-color);
        }
        
        .nav-dropdown:hover .dropdown-menu {
            display: block;
        }
        
        .nav-dropdown:hover .dropdown-toggle {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        
        .summary-label {
            color: var(--secondary-color);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.5rem;
        }
        
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
            min-width: 150px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .kpi-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .kpi-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        
        .kpi-domain {
            background: #005a8c;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            align-self: flex-end;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .kpi-domain:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: #004a7a;
        }
        
        .kpi-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            line-height: 1.4;
            cursor: help;
            position: relative;
        }
        
        .kpi-title:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: #1f2937;
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: normal;
            line-height: 1.4;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            white-space: normal;
            max-width: none;
        }
        
        /* Steward Info Styles */
        .steward-info {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .primary-steward {
            background: var(--secondary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .additional-stewards {
            background: var(--secondary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            cursor: help;
        }
        
        .additional-stewards:hover {
            background: #5a6268;
        }
        
        .kpi-image-section {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .kpi-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .kpi-image:hover {
            transform: scale(1.02);
            cursor: pointer;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            position: relative;
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-image {
            width: 100%;
            height: auto;
            border-radius: 12px;
            display: block;
        }
        
        .close-modal {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .close-modal:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .modal-caption {
            position: absolute;
            bottom: -40px;
            left: 0;
            right: 0;
            color: white;
            text-align: center;
            font-size: 1rem;
            font-weight: 500;
        }
        

        
        .kpi-main-value {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .main-value-label {
            font-size: 0.875rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .main-value-number {
            font-size: 5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }
        
        .main-value-unit {
            font-size: 1.25rem;
            color: #6b7280;
            margin-left: 0.25rem;
        }
        
        .trend-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .trend-icon {
            font-size: 1.25rem;
        }
        
        .trend-up {
            color: var(--success-color);
        }
        
        .trend-down {
            color: var(--danger-color);
        }
        
        .trend-stable {
            color: var(--secondary-color);
        }
        
        .trend-text {
            font-size: 1rem;
            font-weight: 500;
        }
        
        .previous-value {
            font-size: 0.875rem;
            color: #6b7280;
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 1px solid #e5e7eb;
        }
        
        .previous-value-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .previous-value-number {
            font-weight: 600;
        }
        
        .target-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .target-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .target-progress {
            background: #f3f4f6;
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
        }
        
        .target-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #15803d);
            transition: width 0.3s ease;
        }
        
        .target-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .no-target {
            font-size: 0.875rem;
            color: #9ca3af;
            font-style: italic;
        }
        
        /* Notes Section Styles */
        .notes-section {
            margin-top: 1rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid var(--info-color);
        }
        
        .notes-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .notes-content {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.6;
            font-weight: 400;
        }
        
        .notes-content p {
            margin: 0 0 0.5rem 0;
        }
        
        .notes-content p:last-child {
            margin-bottom: 0;
        }
        
        .notes-content strong {
            font-weight: 600;
            color: #374151;
        }
        
        .notes-content em {
            font-style: italic;
            color: #6b7280;
        }
        
        .notes-content code {
            background: #e5e7eb;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8em;
        }
        
        /* Labels Section Styles */
        .labels-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: flex-start;
        }
        
        /* Tag Label Styles */
        .tag-label {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tag-label:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: #b91c1c;
        }
        
        /* Tag color variations */
        .tag-kpi {
            background: var(--primary-color); /* Red - reserved for KPI */
        }
        
        .tag-accelerator {
            background: var(--success-color); /* Green */
        }
        
        .tag-accelerators {
            background: var(--success-color); /* Green - plural form */
        }
        
        .tag-community {
            background: var(--info-color); /* Light blue */
        }
        
        .tag-standards {
            background: var(--warning-color); /* Yellow */
        }
        
        .tag-implementation {
            background: var(--danger-color); /* Orange */
        }
        
        /* Additional tag colors for variety */
        .tag-engagement {
            background: #8b5cf6; /* Purple */
        }
        
        .tag-financial {
            background: #10b981; /* Emerald green */
        }
        
        .tag-membership {
            background: #f59e0b; /* Amber */
        }
        
        .tag-technology {
            background: #6366f1; /* Indigo */
        }
        
        .tag-events {
            background: #ec4899; /* Pink */
        }
        
        /* Toggle Switch Styles */
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            user-select: none;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        /* Active Filters Styles */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            min-height: 2rem;
        }
        
        .active-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .active-filter:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .remove-filter {
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .remove-filter:hover {
            opacity: 1;
        }
        
        /* Active filter color variations */
        .filter-domain {
            background: #005a8c; /* Blue - reserved for domains */
        }
        
        .filter-kpi {
            background: var(--primary-color); /* Red - reserved for KPI */
        }
        
        .filter-accelerator {
            background: var(--success-color); /* Green */
        }
        
        .filter-accelerators {
            background: var(--success-color); /* Green - plural form */
        }
        
        .filter-community {
            background: var(--info-color); /* Light blue */
        }
        
        .filter-standards {
            background: var(--warning-color); /* Yellow */
        }
        
        .filter-implementation {
            background: var(--danger-color); /* Orange */
        }
        
        /* Additional filter colors for variety */
        .filter-engagement {
            background: #8b5cf6; /* Purple */
        }
        
        .filter-financial {
            background: #10b981; /* Emerald green */
        }
        
        .filter-membership {
            background: #f59e0b; /* Amber */
        }
        
        .filter-technology {
            background: #6366f1; /* Indigo */
        }
        
        .filter-events {
            background: #ec4899; /* Pink */
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: var(--danger-color);
        }
        
        /* WebAwesome Component Styles */
        .wa-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .wa-button:hover {
            background: #b91c1c;
        }
        
        .wa-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-select {
                min-width: auto;
            }
            
            .trend-section {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .previous-value {
                margin-left: 0;
                padding-left: 0;
                border-left: none;
                border-top: 1px solid #e5e7eb;
                padding-top: 0.5rem;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-logo">
                <img src="/static/hl7-international-logo.png" alt="HL7 International" class="logo-image">
            </div>
            <div class="header-title">
                <h1 class="dashboard-title">Indicator Dashboard</h1>
                <p class="dashboard-subtitle">Key Performance Indicators and Organizational Metrics</p>
            </div>
        </div>
        <div class="navigation-container">
            <div class="navigation" id="steward-navigation">
                <!-- Dynamic steward navigation will be loaded here -->
            </div>
        </div>
    </div>
    
    <div class="dashboard-container">
        <!-- Summary Statistics -->
        <div class="summary-stats" id="summary-stats">
            <div class="loading">Loading summary statistics...</div>
        </div>
        
        <!-- Active Filters -->
        <div class="active-filters" id="activeFilters">
            <!-- Active filters will be displayed here -->
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <label class="filter-toggle">
                <div class="toggle-switch">
                    <input type="checkbox" id="kpiFilter">
                    <span class="toggle-slider"></span>
                </div>
                <span class="toggle-label">Show KPIs Only</span>
            </label>
            <button class="wa-button" id="refreshBtn">
                Refresh Data
            </button>
        </div>
        
        <!-- KPI Cards -->
        <div class="kpi-grid" id="kpi-grid">
            <div class="loading">Loading KPI data...</div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <img id="modalImage" class="modal-image" src="" alt="">
            <div id="modalCaption" class="modal-caption"></div>
        </div>
    </div>

    <script>
        // Get steward from template context
        const currentSteward = "{{ steward }}";
        let currentTagFilter = null; // Global variable for tag filtering
        let currentDomainFilter = null; // Global variable for domain filtering
        let activeFilters = new Set(); // Track active filters
        
        // Set active navigation
        document.addEventListener('DOMContentLoaded', function() {
            loadStewardNavigation();
            loadDashboardData();
        });
        
        // Load steward navigation dynamically
        async function loadStewardNavigation() {
            try {
                const response = await fetch('/api/stewards');
                const stewards = await response.json();
                
                const navigationHtml = stewards.map(steward => {
                    const isActive = steward === currentSteward ? 'active' : '';
                    
                    // Special handling for Finance steward - create dropdown instead of direct link
                    if (steward === 'Finance') {
                        return `<div class="nav-dropdown"><a href="/Finance" class="nav-link ${isActive}" id="nav-finance">Finance</a><div class="dropdown-menu"><a href="/financial-health" class="dropdown-item">Financial Health Trends and Insights</a></div></div>`;
                    }
                    
                    const href = (steward === 'HL7 International' || steward === 'HL7') ? '/' : `/${steward}`;
                    return `<a href="${href}" class="nav-link ${isActive}" id="nav-${steward.toLowerCase().replace(/\s+/g, '-')}">${steward}</a>`;
                }).join('');
                
                document.getElementById('steward-navigation').innerHTML = navigationHtml;
            } catch (error) {
                console.error('Error loading steward navigation:', error);
                // Fallback to basic navigation
                document.getElementById('steward-navigation').innerHTML = `
                    <a href="/" class="nav-link ${(currentSteward === 'HL7 International' || currentSteward === 'HL7') ? 'active' : ''}">HL7 International</a>
                    <a href="/CSDO" class="nav-link ${currentSteward === 'CSDO' ? 'active' : ''}">CSDO</a>
                    <div class="nav-dropdown"><a href="/Finance" class="nav-link ${currentSteward === 'Finance' ? 'active' : ''}">Finance</a><div class="dropdown-menu"><a href="/financial-health" class="dropdown-item">Financial Health Trends and Insights</a></div></div>
                `;
            }
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const kpiFilter = document.getElementById('kpiFilter');
                const kpiOnly = kpiFilter ? kpiFilter.checked : false;
                await Promise.all([
                    loadSummaryStats(),
                    loadKPICards(currentDomainFilter, kpiOnly, currentTagFilter),
                    loadDomainFilter()
                ]);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }
        
        // Load summary statistics
        async function loadSummaryStats() {
            try {
                const [summaryResponse, metadataResponse] = await Promise.all([
                    fetch(`/api/summary?steward=${encodeURIComponent(currentSteward)}`),
                    fetch('/api/metadata')
                ]);
                
                const summary = await summaryResponse.json();
                const metadata = await metadataResponse.json();
                
                // Set the refresh timestamp for cache busting
                if (metadata.refresh_timestamp) {
                    window.metadataRefreshTimestamp = metadata.refresh_timestamp;
                }
                
                const summaryHtml = `
                    <div class="summary-card">
                        <div class="summary-value">${formatNumber(summary.total_indicators)}</div>
                        <div class="summary-label">Total Indicators</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${formatNumber(Object.keys(summary.indicators_by_domain).length)}</div>
                        <div class="summary-label">Domains</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.latest_period}</div>
                        <div class="summary-label">Latest Period</div>
                    </div>
                `;
                
                document.getElementById('summary-stats').innerHTML = summaryHtml;
            } catch (error) {
                console.error('Error loading summary stats:', error);
            }
        }
        
        // Update summary statistics based on current filters
        async function updateSummaryStats() {
            try {
                let url = `/api/summary?steward=${encodeURIComponent(currentSteward)}`;
                if (currentDomainFilter) url += `&domain=${encodeURIComponent(currentDomainFilter)}`;
                if (currentTagFilter) url += `&tag_filter=${encodeURIComponent(currentTagFilter)}`;
                
                const response = await fetch(url);
                const summary = await response.json();
                
                const summaryHtml = `
                    <div class="summary-card">
                        <div class="summary-value">${formatNumber(summary.total_indicators)}</div>
                        <div class="summary-label">Total Indicators</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${formatNumber(Object.keys(summary.indicators_by_domain).length)}</div>
                        <div class="summary-label">Domains</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.latest_period}</div>
                        <div class="summary-label">Latest Period</div>
                    </div>
                `;
                
                document.getElementById('summary-stats').innerHTML = summaryHtml;
            } catch (error) {
                console.error('Error updating summary stats:', error);
            }
        }
        
        // Load KPI cards
        async function loadKPICards(domain = null, kpiOnly = false, tagFilter = null) {
            try {
                let url = `/api/kpi-cards?steward=${encodeURIComponent(currentSteward)}`;
                if (domain) url += `&domain=${encodeURIComponent(domain)}`;
                if (kpiOnly) url += '&kpi_only=true';
                if (tagFilter) url += `&tag_filter=${encodeURIComponent(tagFilter)}`;
                
                const response = await fetch(url);
                const kpiCards = await response.json();
                
                if (kpiCards.length === 0) {
                    document.getElementById('kpi-grid').innerHTML = '<div class="error">No KPI data available</div>';
                    return;
                }
                
                const cardsHtml = kpiCards.map(card => createKPICardHTML(card)).join('');
                document.getElementById('kpi-grid').innerHTML = cardsHtml;
                
                // Add event listeners for tag and domain labels
                addLabelClickListeners();
            } catch (error) {
                console.error('Error loading KPI cards:', error);
                document.getElementById('kpi-grid').innerHTML = '<div class="error">Failed to load KPI data</div>';
            }
        }
        
        // Add click listeners for tag and domain labels
        function addLabelClickListeners() {
            // Tag labels
            const tagLabels = document.querySelectorAll('.tag-label');
            tagLabels.forEach(tag => {
                tag.addEventListener('click', function() {
                    const tagValue = this.getAttribute('data-tag');
                    const kpiOnly = document.getElementById('kpiFilter').checked;
                    
                    // Add tag filter
                    addFilter('tag', tagValue);
                    loadKPICards(currentDomainFilter, kpiOnly, tagValue);
                });
            });
            
            // Domain labels
            const domainLabels = document.querySelectorAll('.kpi-domain');
            domainLabels.forEach(domain => {
                domain.addEventListener('click', function() {
                    const domainValue = this.textContent;
                    const kpiOnly = document.getElementById('kpiFilter').checked;
                    
                    // Add domain filter
                    addFilter('domain', domainValue);
                    loadKPICards(domainValue, kpiOnly, currentTagFilter);
                });
            });
        }
        
        // Add a filter to the active filters
        function addFilter(type, value) {
            const filterKey = `${type}:${value}`;
            if (!activeFilters.has(filterKey)) {
                activeFilters.add(filterKey);
                if (type === 'tag') {
                    currentTagFilter = value;
                    // If adding KPI tag, check the toggle
                    if (value === 'KPI') {
                        document.getElementById('kpiFilter').checked = true;
                    }
                } else if (type === 'domain') {
                    currentDomainFilter = value;
                }
                updateActiveFiltersDisplay();
                
                // Update summary stats when filters change
                updateSummaryStats();
            }
        }
        
        // Remove a filter
        function removeFilter(type, value) {
            const filterKey = `${type}:${value}`;
            if (activeFilters.has(filterKey)) {
                activeFilters.delete(filterKey);
                if (type === 'tag' && currentTagFilter === value) {
                    currentTagFilter = null;
                } else if (type === 'domain' && currentDomainFilter === value) {
                    currentDomainFilter = null;
                }
                updateActiveFiltersDisplay();
                
                // If removing KPI tag, uncheck the toggle
                if (type === 'tag' && value === 'KPI') {
                    document.getElementById('kpiFilter').checked = false;
                }
                
                // Reload cards with updated filters
                const kpiOnly = document.getElementById('kpiFilter').checked;
                loadKPICards(currentDomainFilter, kpiOnly, currentTagFilter);
                
                // Update summary stats when filters change
                updateSummaryStats();
            }
        }
        
        // Update the active filters display
        function updateActiveFiltersDisplay() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            let html = '';
            
            activeFilters.forEach(filterKey => {
                const [type, value] = filterKey.split(':');
                const filterClass = `filter-${type === 'tag' ? value.toLowerCase() : 'domain'}`;
                const filterLabel = type === 'tag' ? value : value;
                
                html += `
                    <div class="active-filter ${filterClass}" data-filter="${filterKey}">
                        <span>${filterLabel}</span>
                        <span class="remove-filter" onclick="removeFilter('${type}', '${value}')">×</span>
                    </div>
                `;
            });
            
            activeFiltersContainer.innerHTML = html;
        }
        
        // Format number with comma separators
        function formatNumber(num) {
            if (num === null || num === undefined || num === 'N/A') {
                return 'N/A';
            }
            if (typeof num === 'string') {
                return num;
            }
            return num.toLocaleString();
        }
        
        // Create KPI card HTML
        function createKPICardHTML(card) {
            const currentValue = formatNumber(card.current_value);
            const previousValue = formatNumber(card.previous_value);
            const unit = card.indicator.unit;
            const currentPeriod = card.indicator.measurements ? Object.keys(card.indicator.measurements).slice(-1)[0] : 'N/A';
            const previousPeriod = card.indicator.measurements ? Object.keys(card.indicator.measurements).slice(-2, -1)[0] : 'N/A';
            
            // Image section - only show if image exists
            let imageHtml = '';
            if (card.indicator.image) {
                // Add cache-busting parameter based on data refresh timestamp
                // This ensures images are refreshed when data is updated, but not on every page load
                const cacheBuster = window.dataRefreshTimestamp || window.metadataRefreshTimestamp || Date.now();
                const imageSrc = `/static/indicators/${card.indicator.image}?v=${cacheBuster}`;
                imageHtml = `
                    <div class="kpi-image-section">
                        <img src="${imageSrc}" alt="${card.indicator.name}" class="kpi-image" onclick="openImageModal('${imageSrc}', '${card.indicator.name}')">
                    </div>
                `;
            }
            
            let trendHtml = '';
            let previousValueHtml = '';
            
            if (card.trend) {
                const trendClass = `trend-${card.trend.trend}`;
                const trendIcon = card.trend.trend === 'up' ? '↗' : card.trend.trend === 'down' ? '↘' : '→';
                const trendText = `${card.trend.change_pct > 0 ? '+' : ''}${card.trend.change_pct.toFixed(1)}%`;
                
                trendHtml = `
                    <div class="trend-section">
                        <span class="trend-icon ${trendClass}">${trendIcon}</span>
                        <span class="trend-text ${trendClass}">${trendText}</span>
                        <div class="previous-value">
                            <div class="previous-value-label">Previous (${previousPeriod})</div>
                            <div class="previous-value-number">${previousValue} ${unit}</div>
                        </div>
                    </div>
                `;
            } else {
                trendHtml = `
                    <div class="trend-section">
                        <span class="trend-text">No trend data</span>
                        <div class="previous-value">
                            <div class="previous-value-label">Previous (${previousPeriod})</div>
                            <div class="previous-value-number">${previousValue} ${unit}</div>
                        </div>
                    </div>
                `;
            }
            
            let targetHtml = '';
            // Use the target information from the API response
            let targetValue = card.target_value;
            let targetType = card.target_type || 'none';
            
            // Only show target section if there's a valid target and progress data
            if (card.progress_to_target !== null && targetValue !== null && targetValue !== 'N/A') {
                const progress = card.progress_to_target;
                let targetLabel = targetType === 'annual' ? 'Progress to Annual Target' : 'Progress to Target';
                
                // Add target operation info for annual targets
                if (targetType === 'annual' && card.indicator.target_operation) {
                    const operation = card.indicator.target_operation === 'average' ? 'Average' : 'Sum';
                    targetLabel += ` (${operation})`;
                }
                
                // For annual targets with sum operation, calculate the year value for display
                let displayValue = currentValue;
                if (targetType === 'annual' && card.indicator.target_operation === 'sum') {
                    const currentYear = currentPeriod.split('-')[0];
                    let yearValue = 0;
                    for (const [period, measurement] of Object.entries(card.indicator.measurements)) {
                        if (period.startsWith(currentYear) && measurement.value !== null) {
                            yearValue += measurement.value;
                        }
                    }
                    displayValue = formatNumber(yearValue);
                }
                
                targetHtml = `
                    <div class="target-section">
                        <div class="target-label">${targetLabel}</div>
                        <div class="target-progress">
                            <div class="target-progress-bar" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        <div class="target-text">${displayValue} / ${formatNumber(targetValue)} ${unit} (${progress.toFixed(1)}%)</div>
                    </div>
                `;
            }
            // If no target is set, targetHtml remains empty and the section won't be displayed
            
            // Get current measurement notes
            const currentMeasurement = card.indicator.measurements[currentPeriod];
            const notes = currentMeasurement && currentMeasurement.notes ? currentMeasurement.notes : null;
            
            // Notes section - only show if notes exist
            let notesHtml = '';
            if (notes) {
                notesHtml = `
                    <div class="notes-section">
                        <div class="notes-label">Notes</div>
                        <div class="notes-content">${notes}</div>
                    </div>
                `;
            }
            
            // Labels section at bottom
            let labelsHtml = `
                <div class="labels-section">
                    <span class="kpi-domain">${card.indicator.domain}</span>
                    ${card.indicator.tags.map(tag => `<span class="tag-label tag-${tag.toLowerCase()}" data-tag="${tag}">${tag}</span>`).join('')}
                </div>
            `;
            
            // Steward info section - show all stewards with red labels
            let stewardHtml = '';
            if (card.indicator.stewards && card.indicator.stewards.length > 0) {
                // Sort stewards with HL7/HL7 International first, then alphabetically
                const sortedStewards = [...card.indicator.stewards];
                const hl7Steward = sortedStewards.find(s => s === "HL7 International" || s === "HL7");
                if (hl7Steward) {
                    sortedStewards.splice(sortedStewards.indexOf(hl7Steward), 1);
                    sortedStewards.sort();
                    sortedStewards.unshift(hl7Steward);
                } else {
                    sortedStewards.sort();
                }
                
                stewardHtml = `
                    <div class="steward-info">
                        ${sortedStewards.map(steward => {
                            // Display "HL7" for both "HL7" and "HL7 International"
                            const displayName = (steward === "HL7 International" || steward === "HL7") ? "HL7" : steward;
                            return `<span class="primary-steward">${displayName}</span>`;
                        }).join('')}
                    </div>
                `;
            }
            
            return `
                <div class="kpi-card">
                    <div class="kpi-header">
                        <h3 class="kpi-title" data-tooltip="${card.indicator.description.replace(/"/g, '&quot;')}">${card.indicator.name}</h3>
                        ${stewardHtml}
                    </div>
                    ${imageHtml}
                    <div class="kpi-main-value">
                        <div class="main-value-label">Current (${currentPeriod})</div>
                        <div class="main-value-number">${currentValue}<span class="main-value-unit">${unit}</span></div>
                    </div>
                    ${trendHtml}
                    ${targetHtml}
                    ${notesHtml}
                    ${labelsHtml}
                </div>
            `;
        }
        
        // Load domain filter options (now just for reference)
        async function loadDomainFilter() {
            try {
                // Get domains filtered by current steward
                const response = await fetch(`/api/summary?steward=${encodeURIComponent(currentSteward)}`);
                const summary = await response.json();
                
                // Add event listener for KPI filter
                document.getElementById('kpiFilter').addEventListener('change', function() {
                    if (this.checked) {
                        // Add KPI tag to active filters
                        addFilter('tag', 'KPI');
                    } else {
                        // Remove KPI tag from active filters if it exists
                        const kpiFilterKey = 'tag:KPI';
                        if (activeFilters.has(kpiFilterKey)) {
                            removeFilter('tag', 'KPI');
                        }
                    }
                    loadKPICards(currentDomainFilter, this.checked, currentTagFilter);
                    updateSummaryStats();
                });
            } catch (error) {
                console.error('Error loading domain filter:', error);
            }
        }
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            try {
                // Show loading state
                this.disabled = true;
                this.textContent = 'Refreshing...';
                
                // Call the refresh endpoint
                const refreshResponse = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!refreshResponse.ok) {
                    throw new Error('Failed to refresh data');
                }
                
                // Set timestamp for cache busting images
                window.dataRefreshTimestamp = Date.now();
                
                // Reload the dashboard data
                await loadDashboardData();
                
                // Show success message
                this.textContent = 'Data Refreshed!';
                setTimeout(() => {
                    this.textContent = 'Refresh Data';
                    this.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                this.textContent = 'Refresh Failed';
                setTimeout(() => {
                    this.textContent = 'Refresh Data';
                    this.disabled = false;
                }, 2000);
                showError('Failed to refresh data');
            }
        });
        
        // Image modal functions
        function openImageModal(imageSrc, caption) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            
            modalImg.src = imageSrc;
            modalCaption.textContent = caption;
            modal.style.display = 'block';
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }
        
        // Modal event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('imageModal');
            const closeBtn = document.querySelector('.close-modal');
            
            // Close modal when clicking the close button
            closeBtn.addEventListener('click', closeImageModal);
            
            // Close modal when clicking outside the image
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeImageModal();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    closeImageModal();
                }
            });
        });
        
        // Show error message
        function showError(message) {
            document.getElementById('kpi-grid').innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html> 