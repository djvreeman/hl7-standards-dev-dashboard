<!DOCTYPE html>
<html lang="en" class="wa-theme-default wa-palette-default wa-brand-red wa-neutral-gray wa-success-green wa-warning-yellow wa-danger-orange">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HL7 Financial Health Dashboard</title>
    
    <!-- WebAwesome CSS -->
    <link rel="stylesheet" href="https://cdn.webawesome.com/css/webawesome.min.css">
    
    <!-- HL7 Brand Fonts -->
    <link rel="stylesheet" href="/static/css/fonts.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom styles -->
    <style>
        :root {
            /* WebAwesome Theme Colors */
            --wa-brand: #dc2626;
            --wa-neutral: #6b7280;
            --wa-success: #16a34a;
            --wa-warning: #ca8a04;
            --wa-danger: #ea580c;
            --wa-primary: #dc2626;
            --wa-secondary: #6b7280;
            --font-family-primary: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            
            /* Chart Color Palette */
            --chart-primary: #dc2626;      /* WebAwesome Red */
            --chart-secondary: #6b7280;    /* WebAwesome Gray */
            --chart-tertiary: #16a34a;      /* WebAwesome Green */
            --chart-quaternary: #ca8a04;    /* WebAwesome Yellow */
            --chart-quinary: #ea580c;       /* WebAwesome Orange */
            --chart-senary: #5f9baf;       /* Light Blue */
            --chart-septenary: #747679;    /* Dark Gray */
            --chart-octonary: #b91c1c;     /* Dark Red */
            
            /* Legacy variables for compatibility */
            --primary-color: var(--wa-brand);
            --secondary-color: var(--wa-neutral);
            --success-color: var(--wa-success);
            --warning-color: var(--wa-warning);
            --danger-color: var(--wa-danger);
            --info-color: var(--chart-senary);
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --border-color: #e2e8f0;
        }
        
        body {
            background-color: var(--background-color);
            font-family: var(--font-family-primary);
            margin: 0;
            padding: 0;
        }
        
        .dashboard-header {
            background: white;
            color: #1f2937;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            padding: 2rem 2rem 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
        }
        
        .logo-image {
            height: 80px;
            width: auto;
        }
        
        .header-title {
            flex: 1;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }
        
        .dashboard-subtitle {
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-top: 0.5rem;
        }
        
        .navigation-container {
            background: linear-gradient(135deg, var(--primary-color), #b91c1c);
            padding: 1rem 2rem;
        }
        
        .navigation {
            display: flex;
            gap: 1rem;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Dropdown Navigation Styles */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .nav-dropdown .nav-link {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            text-decoration: none;
            color: white;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            z-index: 1000;
            border: 1px solid var(--border-color);
            margin-top: 2px;
        }
        
        .dropdown-item {
            display: block;
            padding: 0.75rem 1rem;
            color: #374151;
            text-decoration: none;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: #f9fafb;
            color: var(--primary-color);
        }
        
        .nav-dropdown:hover .dropdown-menu {
            display: block;
        }
        
        .nav-dropdown:hover .dropdown-toggle {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            text-align: center;
            position: relative;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        
        .summary-label {
            color: var(--secondary-color);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.5rem;
        }
        
        .summary-trend {
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        
        .trend-positive {
            color: var(--wa-success);
        }
        
        .trend-negative {
            color: var(--wa-danger);
        }
        
        .trend-neutral {
            color: var(--wa-neutral);
        }
        
        .trend-arrow {
            font-size: 0.875rem;
        }
        
        /* Financial Insights Styling */
        .insights-content {
            font-family: var(--font-family-primary);
            line-height: 1.6;
            color: #374151;
        }
        
        .insight-document-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        
        .insight-main-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin: 2rem 0 1rem 0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            position: relative;
        }
        
        .insight-main-title:first-of-type {
            margin-top: 0;
        }
        
        /* Critical Financial Concerns styling */
        .insight-main-title:contains("Critical Financial Concerns") {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border-left: 4px solid var(--wa-danger);
            color: #991b1b;
        }
        
        /* Positive Developments styling */
        .insight-main-title:contains("Positive Developments") {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left: 4px solid var(--wa-success);
            color: #166534;
        }
        
        /* Strategic Recommendations styling */
        .insight-main-title:contains("Strategic Recommendations") {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            border-left: 4px solid var(--wa-warning);
            color: #92400e;
        }
        
        .insight-section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin: 1.5rem 0 0.75rem 0;
            padding: 0.5rem 0;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .insight-list {
            margin: 1rem 0;
            padding-left: 0;
            list-style: none;
        }
        
        .insight-list-item {
            margin: 0.75rem 0;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid var(--wa-neutral);
            transition: all 0.2s ease;
        }
        
        .insight-list-item:hover {
            background: #f3f4f6;
            border-left-color: #6b7280;
        }
        
        .insight-paragraph {
            margin: 1rem 0;
            color: #4b5563;
        }
        
        .insight-bold {
            font-weight: 700;
            color: #1f2937;
        }
        
        .insight-italic {
            font-style: italic;
            color: #6b7280;
        }
        
        .insight-code {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #1f2937;
        }
        
        .insight-hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--wa-neutral), transparent);
            margin: 2rem 0;
        }
        
        /* Special styling for different sections */
        .insights-content h2:first-of-type {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border-left: 4px solid var(--wa-danger);
            color: #991b1b;
        }
        
        .insights-content h2:nth-of-type(2) {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left: 4px solid var(--wa-success);
            color: #166534;
        }
        
        .insights-content h2:nth-of-type(3) {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            border-left: 4px solid var(--wa-warning);
            color: #92400e;
        }
        
        /* Detailed Financial Data Table Styling */
        .financial-data-table {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .table-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .financial-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-family-primary);
            font-size: 0.875rem;
            margin-top: 1rem;
        }
        
        .financial-table th {
            background: var(--wa-brand);
            color: white;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: center;
            border: 1px solid #b91c1c;
        }
        
        .financial-table th:first-child {
            text-align: left;
            padding-left: 1rem;
        }
        
        .financial-table td {
            padding: 0.75rem 0.5rem;
            border: 1px solid #e5e7eb;
            text-align: right;
            vertical-align: middle;
        }
        
        .financial-table td:first-child {
            text-align: left;
            padding-left: 1rem;
            font-weight: 500;
        }
        
        .financial-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .financial-table tr:hover {
            background-color: #f3f4f6;
        }
        
        .metric-name {
            font-weight: 600;
            color: #374151;
        }
        
        .metric-name.bold {
            font-weight: 700;
            color: #1f2937;
        }
        
        .currency-value {
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }
        
        .percentage-positive {
            color: var(--wa-success);
            font-weight: 600;
        }
        
        .percentage-negative {
            color: var(--wa-danger);
            font-weight: 600;
        }
        
        .percentage-neutral {
            color: var(--wa-neutral);
            font-weight: 600;
        }
        
        .note-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .note-title {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 0.5rem;
        }
        
        .note-content {
            color: #78350f;
        }
        
        @media (max-width: 768px) {
            .financial-table {
                font-size: 0.75rem;
            }
            
            .financial-table th,
            .financial-table td {
                padding: 0.5rem 0.25rem;
            }
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .charts-grid.single-column {
            grid-template-columns: 1fr;
        }
        
        .layout-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        
        .layout-toggle {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .layout-toggle:hover {
            background: var(--background-color);
        }
        
        .layout-toggle.active {
            background: var(--wa-brand);
            color: white;
            border-color: var(--wa-brand);
        }
        
        .chart-container {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: var(--danger-color);
        }
        
        .refresh-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
            margin-bottom: 2rem;
        }
        
        .refresh-button:hover {
            background: #b91c1c;
        }
        
        .refresh-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .financial-insights {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            margin-top: 2rem;
        }
        
        .insights-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .insight-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .insight-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .insight-value {
            color: var(--secondary-color);
            font-size: 0.875rem;
        }
        
        .positive {
            color: var(--success-color);
        }
        
        .negative {
            color: var(--danger-color);
        }
        
        .neutral {
            color: var(--secondary-color);
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-logo">
                <img src="/static/hl7-international-logo.png" alt="HL7 International" class="logo-image">
            </div>
            <div class="header-title">
                <h1 class="dashboard-title">Financial Health Dashboard</h1>
                <p class="dashboard-subtitle">HL7 International Financial Performance Analysis</p>
            </div>
        </div>
        <div class="navigation-container">
            <div class="navigation" id="steward-navigation">
                <!-- Dynamic steward navigation will be loaded here -->
            </div>
        </div>
    </div>
    
    <div class="dashboard-container">
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
            <button class="refresh-button" id="refreshBtn">
                Refresh Financial Data
            </button>
            <button class="refresh-button" id="generatePromptBtn" style="background: var(--wa-success);">
                Generate LLM Prompt
            </button>
        </div>
        
        <!-- Summary Statistics -->
        <div class="summary-stats" id="summary-stats">
            <div class="loading">Loading financial summary...</div>
        </div>
        
        <!-- Layout Controls -->
        <div class="layout-controls">
            <button class="layout-toggle" id="twoColumnBtn">Two Column</button>
            <button class="layout-toggle active" id="singleColumnBtn">Single Column</button>
        </div>
        
        <!-- Charts Grid -->
        <div class="charts-grid single-column" id="charts-grid">
            <!-- Revenue vs Expenses Trend -->
            <div class="chart-container">
                <div class="chart-title">Revenue vs Expenses Trend</div>
                <div class="chart-wrapper">
                    <canvas id="revenueExpenseChart"></canvas>
                </div>
            </div>
            
            <!-- Revenue Composition -->
            <div class="chart-container">
                <div class="chart-title">Revenue Composition by Source</div>
                <div class="chart-wrapper">
                    <canvas id="revenueCompositionChart"></canvas>
                </div>
            </div>
            
            <!-- Key Revenue Streams -->
            <div class="chart-container">
                <div class="chart-title">Key Revenue Streams Over Time</div>
                <div class="chart-wrapper">
                    <canvas id="keyRevenueStreamsChart"></canvas>
                </div>
            </div>
            
            <!-- Expense Breakdown -->
            <div class="chart-container">
                <div class="chart-title">Expense Breakdown</div>
                <div class="chart-wrapper">
                    <canvas id="expenseBreakdownChart"></canvas>
                </div>
            </div>
            
            <!-- Program Service Revenue Breakdown -->
            <div class="chart-container">
                <div class="chart-title">Program Service Revenue Breakdown</div>
                <div class="chart-wrapper">
                    <canvas id="programServiceBreakdownChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Detailed Financial Data Table -->
        <div class="financial-data-table" id="financial-data-table">
            <div class="loading">Loading detailed financial data...</div>
        </div>
        
        <!-- Financial Insights -->
        <div class="financial-insights" id="financial-insights">
            <div class="insights-title">Financial Insights & Key Findings</div>
            <div class="loading">Loading insights...</div>
        </div>
    </div>

    <script>
        let charts = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            loadStewardNavigation();
            loadFinancialData();
            setupLayoutControls();
        });
        
        // Load steward navigation dynamically
        async function loadStewardNavigation() {
            try {
                const response = await fetch('/api/stewards');
                const stewards = await response.json();
                
                const navigationHtml = stewards.map(steward => {
                    const isActive = steward === 'HL7 International' || steward === 'HL7' ? 'active' : '';
                    
                    // Special handling for Finance steward - create dropdown instead of direct link
                    if (steward === 'Finance') {
                        return `<div class="nav-dropdown"><a href="/Finance" class="nav-link active" id="nav-finance">Finance</a><div class="dropdown-menu"><a href="/finance" class="dropdown-item">Financial Health Trends and Insights</a></div></div>`;
                    }
                    
                    const href = (steward === 'HL7 International' || steward === 'HL7') ? '/' : `/${steward}`;
                    return `<a href="${href}" class="nav-link ${isActive}" id="nav-${steward.toLowerCase().replace(/\s+/g, '-')}">${steward}</a>`;
                }).join('');
                
                document.getElementById('steward-navigation').innerHTML = navigationHtml;
            } catch (error) {
                console.error('Error loading steward navigation:', error);
                // Fallback to basic navigation
                document.getElementById('steward-navigation').innerHTML = `
                    <a href="/" class="nav-link">HL7 International</a>
                    <a href="/CSDO" class="nav-link">CSDO</a>
                    <div class="nav-dropdown"><a href="/Finance" class="nav-link active">Finance</a><div class="dropdown-menu"><a href="/finance" class="dropdown-item">Financial Health Trends and Insights</a></div></div>
                `;
            }
        }
        
        async function loadFinancialData() {
            try {
                await Promise.all([
                    loadSummaryStats(),
                    loadDetailedTable(),
                    loadCharts(),
                    loadFinancialInsights()
                ]);
            } catch (error) {
                console.error('Error loading financial data:', error);
                showError('Failed to load financial data');
            }
        }
        
        async function loadSummaryStats() {
            try {
                const response = await fetch('/api/financial/summary');
                const summary = await response.json();
                
                const summaryHtml = `
                    <div class="summary-card">
                        <div class="summary-value">$${formatCurrency(summary.total_revenue)}</div>
                        <div class="summary-label">${summary.latest_year} TOTAL REVENUE</div>
                        <div class="summary-trend ${summary.revenue_change >= 0 ? 'trend-positive' : 'trend-negative'}">
                            <span class="trend-arrow">${summary.revenue_change >= 0 ? '↑' : '↓'}</span>
                            ${Math.abs(summary.revenue_change).toFixed(1)}% vs ${summary.previous_year}
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">$${formatCurrency(summary.total_expenses)}</div>
                        <div class="summary-label">${summary.latest_year} TOTAL EXPENSES</div>
                        <div class="summary-trend ${summary.expense_change <= 0 ? 'trend-positive' : 'trend-negative'}">
                            <span class="trend-arrow">${summary.expense_change <= 0 ? '↓' : '↑'}</span>
                            ${Math.abs(summary.expense_change).toFixed(1)}% vs ${summary.previous_year}
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value ${summary.net_income >= 0 ? 'positive' : 'negative'}">$${formatCurrency(summary.net_income)}</div>
                        <div class="summary-label">${summary.latest_year} ${summary.net_income >= 0 ? 'NET INCOME' : 'NET DEFICIT'}</div>
                        <div class="summary-trend ${summary.net_income_improvement ? 'trend-positive' : 'trend-negative'}">
                            <span class="trend-arrow">${summary.net_income_improvement ? '↑' : '↓'}</span>
                            ${summary.net_income_improvement ? 'Better' : 'Worse'} than ${summary.previous_year} (${summary.net_income_change > 0 ? '+' : ''}$${formatCurrency(summary.net_income_change)})
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">$${formatCurrency(summary.net_assets)}</div>
                        <div class="summary-label">${summary.latest_year} NET ASSETS</div>
                        <div class="summary-trend ${summary.assets_change >= 0 ? 'trend-positive' : 'trend-negative'}">
                            <span class="trend-arrow">${summary.assets_change >= 0 ? '↑' : '↓'}</span>
                            ${Math.abs(summary.assets_change).toFixed(1)}% vs ${summary.previous_year}
                        </div>
                    </div>
                `;
                
                document.getElementById('summary-stats').innerHTML = summaryHtml;
            } catch (error) {
                console.error('Error loading summary stats:', error);
            }
        }
        
        async function loadDetailedTable() {
            try {
                const response = await fetch('/api/financial/detailed-table');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('financial-data-table').innerHTML = 
                        `<div class="error">${data.error}</div>`;
                    return;
                }
                
                // Build table HTML
                const yearRange = `${data.years[0]}-${data.years[data.years.length - 1]}`;
                let tableHtml = `
                    <div class="table-title">Detailed Financial Data (${yearRange})</div>
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>METRIC</th>
                `;
                
                // Add year headers
                for (const year of data.years) {
                    tableHtml += `<th>${year}</th>`;
                }
                tableHtml += `<th>${data.year_span}</th></tr></thead><tbody>`;
                
                // Add data rows
                for (const metric of data.metrics) {
                    tableHtml += `<tr>`;
                    tableHtml += `<td class="metric-name ${metric.bold ? 'bold' : ''}">${metric.name}</td>`;
                    
                    // Add year values
                    for (const value of metric.values) {
                        const formattedValue = formatCurrency(value);
                        const colorClass = value < 0 ? 'negative' : '';
                        tableHtml += `<td class="currency-value ${colorClass}">$${formattedValue}</td>`;
                    }
                    
                    // Add change percentage
                    if (metric.change !== null) {
                        const changeClass = metric.change >= 0 ? 'percentage-positive' : 'percentage-negative';
                        const sign = metric.change >= 0 ? '+' : '';
                        tableHtml += `<td class="${changeClass}">${sign}${metric.change.toFixed(1)}%</td>`;
                    } else {
                        tableHtml += `<td class="percentage-neutral">N/A</td>`;
                    }
                    
                    tableHtml += `</tr>`;
                }
                
                tableHtml += `</tbody></table>`;
                
                // Add note about AMG LLC acquisition
                tableHtml += `
                    <div class="note-box">
                        <div class="note-title">*Note on 2024 Salary Increase:</div>
                        <div class="note-content">
                            HL7 acquired AMG LLC in 2023. In 2024, AMG staff became HL7 employees. 
                            The 2023 Management Services expense ($3.3M) is now included in 2024 employee compensation. 
                            Combined personnel costs actually decreased from $5.1M (2023) to $4.4M (2024), 
                            reflecting a 13.7% efficiency gain.
                        </div>
                    </div>
                `;
                
                document.getElementById('financial-data-table').innerHTML = tableHtml;
            } catch (error) {
                console.error('Error loading detailed table:', error);
                document.getElementById('financial-data-table').innerHTML = 
                    '<div class="error">Failed to load detailed financial data</div>';
            }
        }
        
        async function loadCharts() {
            try {
            const chartTypes = [
                'revenue-expense-trend',
                'revenue-composition', 
                'key-revenue-streams',
                'expense-breakdown',
                'program-service-breakdown'
            ];
                
                for (const chartType of chartTypes) {
                    await loadChart(chartType);
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }
        
        async function loadChart(chartType) {
            try {
                const response = await fetch(`/api/financial/charts/${chartType}`);
                const chartData = await response.json();
                
                const canvasId = getCanvasId(chartType);
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                // Destroy existing chart if it exists
                if (charts[chartType]) {
                    charts[chartType].destroy();
                }
                
                const config = {
                    type: chartData.type,
                    data: {
                        labels: chartData.labels,
                        datasets: chartData.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: chartData.type === 'line' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + formatCurrency(value);
                                    }
                                }
                            }
                        } : {
                            y: {
                                beginAtZero: true,
                                stacked: chartData.datasets[0].stack ? true : false,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                };
                
                charts[chartType] = new Chart(ctx, config);
            } catch (error) {
                console.error(`Error loading chart ${chartType}:`, error);
            }
        }
        
        function getCanvasId(chartType) {
            const mapping = {
                'revenue-expense-trend': 'revenueExpenseChart',
                'revenue-composition': 'revenueCompositionChart',
                'key-revenue-streams': 'keyRevenueStreamsChart',
                'expense-breakdown': 'expenseBreakdownChart',
                'program-service-breakdown': 'programServiceBreakdownChart'
            };
            return mapping[chartType];
        }
        
        function formatCurrency(value) {
            if (value === null || value === undefined) return '0';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        function showError(message) {
            document.getElementById('summary-stats').innerHTML = `<div class="error">${message}</div>`;
        }
        
        // Layout Controls
        function setupLayoutControls() {
            const twoColumnBtn = document.getElementById('twoColumnBtn');
            const singleColumnBtn = document.getElementById('singleColumnBtn');
            const chartsGrid = document.getElementById('charts-grid');
            
            twoColumnBtn.addEventListener('click', function() {
                chartsGrid.classList.remove('single-column');
                twoColumnBtn.classList.add('active');
                singleColumnBtn.classList.remove('active');
            });
            
            singleColumnBtn.addEventListener('click', function() {
                chartsGrid.classList.add('single-column');
                singleColumnBtn.classList.add('active');
                twoColumnBtn.classList.remove('active');
            });
        }
        
        // Financial Insights
        async function loadFinancialInsights() {
            try {
                const response = await fetch('/api/financial/insights');
                const data = await response.json();
                
                if (data.insights && data.insights !== "No insights file found. Please generate LLM prompt and create insights markdown file.") {
                if (data.format === 'html') {
                    // Display HTML insights with beautiful styling
                    document.getElementById('financial-insights').innerHTML = `
                        <div class="insights-content">${data.insights}</div>
                    `;
                } else {
                    // Fallback to plain text
                    document.getElementById('financial-insights').innerHTML = `
                        <div class="insights-title">Financial Insights & Key Findings</div>
                        <div style="white-space: pre-wrap; font-family: var(--font-family-primary);">${data.insights}</div>
                    `;
                }
                } else {
                    // Fallback to generated insights
                    const healthResponse = await fetch('/api/financial/health');
                    const healthData = await healthResponse.json();
                    const insights = generateFinancialInsights(healthData);
                    document.getElementById('financial-insights').innerHTML = insights;
                }
            } catch (error) {
                console.error('Error loading financial insights:', error);
                document.getElementById('financial-insights').innerHTML = 
                    '<div class="error">Failed to load financial insights</div>';
            }
        }
        
        function generateFinancialInsights(data) {
            const latestYear = data.years[data.years.length - 1];
            const previousYear = data.years[data.years.length - 2];
            
            const revenueGrowth = latestYear && previousYear ? 
                ((latestYear.total_revenue - previousYear.total_revenue) / previousYear.total_revenue * 100) : 0;
            const expenseGrowth = latestYear && previousYear ? 
                ((latestYear.total_expenses - previousYear.total_expenses) / previousYear.total_expenses * 100) : 0;
            
            const membershipDuesPercent = latestYear ? 
                (latestYear.membership_dues / latestYear.total_revenue * 100) : 0;
            const programServicesPercent = latestYear ? 
                (latestYear.program_service_revenue / latestYear.total_revenue * 100) : 0;
            
            return `
                <div class="insight-item">
                    <div class="insight-label">Revenue Growth (${latestYear.year})</div>
                    <div class="insight-value ${revenueGrowth >= 0 ? 'positive' : 'negative'}">
                        ${revenueGrowth >= 0 ? '+' : ''}${revenueGrowth.toFixed(1)}% vs ${previousYear ? previousYear.year : 'N/A'}
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Revenue Composition</div>
                    <div class="insight-value neutral">
                        ${programServicesPercent.toFixed(1)}% Program Services, ${(100-programServicesPercent).toFixed(1)}% Other Sources
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Membership Dues Share</div>
                    <div class="insight-value neutral">
                        ${membershipDuesPercent.toFixed(1)}% of Total Revenue
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Financial Health</div>
                    <div class="insight-value ${latestYear.net_income >= 0 ? 'positive' : 'negative'}">
                        ${latestYear.net_income >= 0 ? 'Positive' : 'Negative'} Net Income: $${formatCurrency(latestYear.net_income)}
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Key Trend</div>
                    <div class="insight-value neutral">
                        ${revenueGrowth > 0 ? 'Revenue growth' : 'Revenue decline'} of ${Math.abs(revenueGrowth).toFixed(1)}% in ${latestYear.year}
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">AMG LLC Acquisition Impact</div>
                    <div class="insight-value neutral">
                        Management services expenses integrated into employee compensation in 2024
                    </div>
                </div>
            `;
        }
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            try {
                this.disabled = true;
                this.textContent = 'Refreshing...';
                
                const response = await fetch('/api/financial/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to refresh financial data');
                }
                
                await loadFinancialData();
                
                this.textContent = 'Data Refreshed!';
                setTimeout(() => {
                    this.textContent = 'Refresh Financial Data';
                    this.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                this.textContent = 'Refresh Failed';
                setTimeout(() => {
                    this.textContent = 'Refresh Financial Data';
                    this.disabled = false;
                }, 2000);
            }
        });
        
        // LLM Prompt Generation button
        document.getElementById('generatePromptBtn').addEventListener('click', async function() {
            try {
                this.disabled = true;
                this.textContent = 'Generating...';
                
                const response = await fetch('/api/financial/llm-prompt');
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.textContent = 'Prompt Generated!';
                    alert(`LLM prompt generated successfully!\n\nFile saved to: ${data.prompt_file}\n\nNext steps:\n1. Copy the prompt from the file\n2. Paste it into your favorite LLM (ChatGPT, Claude, etc.)\n3. The LLM will generate a markdown-formatted analysis\n4. Save the LLM's response as 'data/processed/financial_insights.md'\n5. Refresh the dashboard to see the formatted insights\n\nNote: The LLM has been instructed to create a complete markdown file with proper formatting.`);
                } else {
                    throw new Error(data.message || 'Failed to generate prompt');
                }
                
                setTimeout(() => {
                    this.textContent = 'Generate LLM Prompt';
                    this.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('Error generating prompt:', error);
                this.textContent = 'Generation Failed';
                alert('Failed to generate LLM prompt: ' + error.message);
                setTimeout(() => {
                    this.textContent = 'Generate LLM Prompt';
                    this.disabled = false;
                }, 2000);
            }
        });
    </script>
</body>
</html>
